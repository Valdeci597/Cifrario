<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cifr√°rio</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#121212" />
  <link rel="icon" href="icon-192.png" />
  <style>
    :root {
      --bg-dark: #121212;
      --text-dark: #ffffff;
      --bg-light: #ffffff;
      --text-light: #000000;
      --chord-color: #4ea8de;
    }
    body {
      margin: 0;
      font-family: monospace;
      background-color: var(--bg-dark);
      color: var(--text-dark);
      font-size: 18px;
    }
    body.light {
      background-color: var(--bg-light);
      color: var(--text-light);
    }
    .controls {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 999;
    }
    .controls button {
      font-size: 1rem;
      padding: 8px;
      border: none;
      border-radius: 8px;
      background: #222;
      color: white;
      cursor: pointer;
    }
    .formatted-cifra {
      white-space: pre-wrap;
      padding: 140px 20px 20px;
    }
    .chord {
      color: var(--chord-color);
      font-weight: bold;
    }
    .tablatura {
      color: lightblue;
      font-family: monospace;
    }
    .tablatura-hidden .tablatura {
      display: none;
    }
    .gear {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #222;
      color: white;
      border-radius: 50%;
      padding: 10px;
      font-size: 24px;
      cursor: pointer;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="controls" id="painel">
    <button onclick="toggleTheme()">üåó Tema</button>
    <button onclick="adjustFont(2)">A+</button>
    <button onclick="adjustFont(-2)">A‚àí</button>
    <button onclick="transpose(1)">üî∫ Subir tom</button>
    <button onclick="transpose(-1)">üîª Descer tom</button>
    <button onclick="toggleScroll()">‚ñ∂Ô∏è Rolagem</button>
    <label>Velocidade: <input id="scrollSpeed" type="range" min="1" max="10" value="3" oninput="updateScrollLabel()"/> <span id="scrollPercent">30%</span></label>
    <button onclick="toggleTablatura()">üé∏ Ocultar tablatura</button>
  </div>

  <div class="gear" onclick="togglePainel()">‚öôÔ∏è</div>

  <main id="cifraDisplay">
    <pre class="formatted-cifra">Cole ou carregue uma cifra para come√ßar.</pre>
  </main>
  <script>
    let scrollInterval = null;
    let cifraOriginal = '';
    let ocultarTab = false;

    const notas = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const bemolMap = { 'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#' };

    function normalizar(n) {
      return bemolMap[n] || n;
    }

    function transporNota(nota, delta) {
      const match = nota.match(/^([A-G][b#]?)(.*)$/);
      if (!match) return nota;
      let [_, raiz, sufixo] = match;
      raiz = normalizar(raiz);
      let i = notas.indexOf(raiz);
      if (i < 0) return nota;
      let nova = notas[(i + delta + 12) % 12];
      return nova + sufixo;
    }

    function transpose(delta) {
      if (!cifraOriginal) return;
      const linhas = cifraOriginal.split('\n').map(l => {
        l = l.replace(/\[([^\]]+)\]/g, (_, acorde) => `[${transporNota(acorde, delta)}]`);
        l = l.replace(/\b([A-G][b#]?(m7|maj7|m|dim|aug|sus\d?|add\d*|\/[A-G][b#]?|)?[^\s]*)\b/g, acorde => transporNota(acorde, delta));
        return l;
      });
      cifraOriginal = linhas.join('\n');
      salvarCifra();
      renderCifra();
    }

    function renderCifra() {
      const linhas = cifraOriginal.split('\n');
      let html = '', i = 0;
      while (i < linhas.length) {
        const bloco6 = linhas.slice(i, i+6);
        const ehTab = bloco6.length === 6 && /^[Ee]\|/.test(bloco6[0]);
        if (ehTab) {
          html += `<div class="tablatura">${bloco6.join('\n')}</div>\n`;
          i += 6;
        } else {
          html += linhas[i].replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>')
                          .replace(/\b([A-G][b#]?(m7|maj7|m|dim|aug|sus\d?|add\d*|\/[A-G][b#]?|)?[^\s]*)\b/g, '<span class="chord">$1</span>') + '\n';
          i++;
        }
      }
      document.getElementById("cifraDisplay").innerHTML = `<pre class="formatted-cifra">${html}</pre>`;
    }

    function toggleTheme() {
      document.body.classList.toggle('light');
    }

    function adjustFont(delta) {
      let fs = parseFloat(getComputedStyle(document.body).fontSize);
      document.body.style.fontSize = (fs + delta) + 'px';
    }

    function toggleScroll() {
      if (scrollInterval) {
        clearInterval(scrollInterval);
        scrollInterval = null;
      } else {
        const speed = +document.getElementById("scrollSpeed").value;
        scrollInterval = setInterval(() => window.scrollBy(0, speed), 100);
      }
    }

    function updateScrollLabel() {
      const speed = document.getElementById("scrollSpeed").value;
      document.getElementById("scrollPercent").innerText = (speed * 10) + '%';
    }

    function toggleTablatura() {
      ocultarTab = !ocultarTab;
      document.body.classList.toggle('tablatura-hidden', ocultarTab);
    }

    function togglePainel() {
      const painel = document.getElementById("painel");
      painel.style.display = painel.style.display === 'none' ? 'flex' : 'none';
    }

    function salvarCifra() {
      localStorage.setItem('cifraSalva', cifraOriginal);
    }

    function carregarCifraSalva() {
      const salva = localStorage.getItem('cifraSalva');
      if (salva) {
        cifraOriginal = salva;
        renderCifra();
      }
    }

    async function carregarCifraDeURL(url) {
      try {
        const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
        const data = await res.json();
        const html = data.contents;
        const div = document.createElement('div');
        div.innerHTML = html;
        const pre = div.querySelector('pre');
        if (pre) {
          cifraOriginal = pre.innerText.trim();
          salvarCifra();
          renderCifra();
        } else {
          alert('Cifra n√£o encontrada.');
        }
      } catch (e) {
        alert('Erro ao carregar cifra.');
      }
    }

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    // Auto carregar
    carregarCifraSalva();

    // Teste autom√°tico (remova depois)
    if (!cifraOriginal) {
      cifraOriginal = `Tom: E

[Intro]
E   A9   B4

E
Me escutas quando clamo
A9          B4        E
E acalma o meu pensar`;
      salvarCifra();
      renderCifra();
    }
  </script>
</body>
</html>
