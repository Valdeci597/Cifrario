<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cifr√°rio</title>
  <meta name="theme-color" content="#4ea8de" />
  <link rel="manifest" href="/Cifrario/manifest.json" />
  <link rel="icon" href="/Cifrario/icon-192.png" type="image/png" />
  <style>
    body {
      font-family: monospace;
      margin: 0;
      padding: 0;
      background-color: #121212;
      color: #fff;
      font-size: 18px;
    }
    .light-mode {
      background: #fff;
      color: #000;
    }
    .controls {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 999;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    button {
      font-size: 1rem;
      padding: 8px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background: #222;
      color: white;
    }
    .chord {
      color: #4ea8de;
      font-weight: bold;
    }
    .formatted-cifra {
      white-space: pre-wrap;
      padding: 140px 20px 20px;
    }
    .tablatura {
      color: lightblue;
      font-family: monospace;
    }
    .tablatura-hidden .tablatura {
      display: none;
    }
    .gear {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #222;
      border-radius: 50%;
      padding: 10px;
      font-size: 24px;
      color: white;
      cursor: pointer;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="controls">
    <button onclick="toggleMode()">üåó Tema</button>
    <button onclick="adjustFont(2)">A+</button>
    <button onclick="adjustFont(-2)">A‚àí</button>
    <button onclick="transpose(1)">üî∫ Subir tom</button>
    <button onclick="transpose(-1)">üîª Descer tom</button>
    <button onclick="toggleScroll()">‚ñ∂Ô∏è Rolagem</button>
    <label>
      Velocidade:
      <input id="scrollSpeed" type="range" min="1" max="10" value="3" oninput="atualizarPorcentagem()" />
      <span id="scrollPercent">30%</span>
    </label>
    <button onclick="toggleTablatura()">üé∏ Ocultar tablatura</button>
  </div>

  <div class="gear" onclick="alternarControles()">‚öôÔ∏è</div>

  <main id="cifraDisplay">
    <pre class="formatted-cifra">Carregando cifra...</pre>
  </main>
  <script>
    let scrollInterval;
    let tablaturaOculta = false;
    let cifraOriginal = `Tom: E

[Intro]
E   A9   B4

E
Me escutas quando clamo
A9          B4        E
E acalma o meu pensar

A9    B4    E
Me levas pelo fogo
A9    B4    E
Curando todo meu ser`;

    const notas = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const bemolToSustenido = {
      'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#'
    };

    function normalizarNota(nota) {
      return bemolToSustenido[nota] || nota;
    }

    function transporNota(nota, delta) {
      const match = nota.match(/^([A-G][b#]?)(.*)$/);
      if (!match) return nota;
      let [_, raiz, sufixo] = match;
      raiz = normalizarNota(raiz);
      let idx = notas.indexOf(raiz);
      if (idx === -1) return nota;
      let novoIdx = (idx + delta + 12) % 12;
      return notas[novoIdx] + sufixo;
    }

    function transpose(delta) {
      if (!cifraOriginal) return;
      const transpostas = cifraOriginal.split('\n').map(linha => {
        linha = linha.replace(/\[([^\]]+)\]/g, (_, acorde) => '[' + transporNota(acorde, delta) + ']');
        linha = linha.replace(/\b([A-G][b#]?(?:m7|maj7|m|dim|aug|sus[24]?|add\d*|[\/][A-G][b#]?)?[^\s]*)\b/g, acorde => transporNota(acorde, delta));
        return linha;
      });
      cifraOriginal = transpostas.join('\n');
      renderCifra(cifraOriginal);
    }

    function renderCifra(raw) {
      const linhas = raw.split('\n');
      let html = '';
      let i = 0;
      while (i < linhas.length) {
        const bloco6 = linhas.slice(i, i + 6);
        const ehTablatura = bloco6.length === 6 &&
          /^[Ee]\|/.test(bloco6[0]) &&
          /^[Bb]\|/.test(bloco6[1]) &&
          /^[Gg]\|/.test(bloco6[2]) &&
          /^[Dd]\|/.test(bloco6[3]) &&
          /^[Aa]\|/.test(bloco6[4]) &&
          /^[Ee]\|/.test(bloco6[5]);
        if (ehTablatura) {
          html += '<div class="tablatura">';
          html += bloco6.join('\n') + '\n</div>\n';
          i += 6;
        } else {
          const linhaComMarcacao = linhas[i].replace(/\b([A-G][b#]?(?:m7|maj7|m|dim|aug|sus[24]?|add\d*|[\/][A-G][b#]?)?[^\s]*)\b/g, '<span class="chord">$1</span>');
          html += linhaComMarcacao + '\n';
          i++;
        }
      }
      document.getElementById("cifraDisplay").innerHTML = `<pre class="formatted-cifra">${html}</pre>`;
    }

    function toggleMode() {
      document.body.classList.toggle('light-mode');
    }

    function adjustFont(delta) {
      const currentSize = parseFloat(getComputedStyle(document.body).fontSize);
      document.body.style.fontSize = (currentSize + delta) + 'px';
    }

    function toggleScroll() {
      if (scrollInterval) {
        clearInterval(scrollInterval);
        scrollInterval = null;
      } else {
        const speed = +document.getElementById("scrollSpeed").value;
        scrollInterval = setInterval(() => window.scrollBy(0, speed), 100);
      }
    }

    function atualizarPorcentagem() {
      const v = document.getElementById("scrollSpeed").value;
      document.getElementById("scrollPercent").textContent = (v * 10) + '%';
    }

    function toggleTablatura() {
      tablaturaOculta = !tablaturaOculta;
      document.body.classList.toggle('tablatura-hidden', tablaturaOculta);
    }

    function alternarControles() {
      const c = document.querySelector('.controls');
      c.style.display = 'flex'; // Nunca some
    }

    // Service Worker (PWA)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/Cifrario/sw.js')
        .then(() => console.log('‚úÖ Service Worker registrado'))
        .catch(err => console.error('Erro no Service Worker:', err));
    }

    atualizarPorcentagem();
    renderCifra(cifraOriginal);
  </script>
</body>
</html>
